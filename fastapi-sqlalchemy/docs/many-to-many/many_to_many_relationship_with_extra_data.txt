
class StudentCourse(PostgresModel):
    __tablename__ = "student_courses"

    student_id = Column(Integer, ForeignKey("students.id"), primary_key=True)
    course_id = Column(Integer, ForeignKey("courses.id"), primary_key=True)

    enrolled_at = Column(DateTime(timezone=True), nullable=False)

    student = relationship("Student", back_populates="student_courses")
    course = relationship("Course", back_populates="student_courses")


class Student(PostgresModel):
    __tablename__ = "students"

    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)

    student_courses = relationship(
        "StudentCourse", back_populates="student", cascade="all, delete-orphan"
    )

    courses = relationship("Course", secondary="student_courses", viewonly=True)


class Course(PostgresModel):
    __tablename__ = "courses"

    id = Column(Integer, primary_key=True)
    title = Column(String, nullable=False)

    student_courses = relationship(
        "StudentCourse", back_populates="course", cascade="all, delete-orphan"
    )

    students = relationship("Student", secondary="student_courses", viewonly=True)


---

from datetime import datetime, UTC

student = Student(name="Ali")
course = Course(title="Math")


enrollment = StudentCourse(student=student, course=course, enrolled_at= datetime.now(UTC))

session.add(enrollment)
await session.commit()

---

await session.delete(student)
await session.commit()

---


from datetime import datetime, UTC

# Create students
students = [
    Student(name="Ali"),
    Student(name="Sara")
]

# Create courses
courses = [
    Course(title="Math"),
    Course(title="Physics"),
    Course(title="Chemistry")
]

# Add all students and courses to the session first
session.add_all(students + courses)
await session.commit()  # Commit to generate IDs if using Identity()

# Create enrollments
enrollments = [
    StudentCourse(student=students[0], course=courses[0], enrolled_at=datetime.now(UTC)),
    StudentCourse(student=students[0], course=courses[1], enrolled_at=datetime.now(UTC)),
    StudentCourse(student=students[1], course=courses[1], enrolled_at=datetime.now(UTC)),
    StudentCourse(student=students[1], course=courses[2], enrolled_at=datetime.now(UTC)),
]

# Add all enrollments in one go
session.add_all(enrollments)
await session.commit()

---


Get all courses of a specific student:


student_id = students[0].id  # Ali

stmt = select(Course).join(StudentCourse).where(StudentCourse.student_id == student_id)
result = await session.execute(stmt)
student_courses = result.scalars().all()

print(f"{students[0].name} is enrolled in:")
for c in student_courses:
    print("-", c.title)

---

Get all students enrolled in a specific course:

course_id = courses[1].id  # Physics

stmt = select(Student).join(StudentCourse).where(StudentCourse.course_id == course_id)
result = await session.execute(stmt)
course_students = result.scalars().all()

print(f"Students in {courses[1].title}:")
for s in course_students:
    print("-", s.name)

---

Get all courses with enrolled students (optional eager load)

stmt = select(Course).options(
    selectinload(Course.students)   
)
result = await session.execute(stmt)
all_courses = result.scalars().all()

for course in all_courses:
    print(f"Course: {course.title}")
    for student in course.students:
        print(" -", student.name)

---

Filter courses enrolled after a certain date:


from datetime import timedelta

cutoff = datetime.now(UTC) - timedelta(days=1)

stmt = select(Course).join(StudentCourse).where(StudentCourse.enrolled_at >= cutoff)
result = await session.execute(stmt)
recent_courses = result.scalars().all()

print("Recently enrolled courses:")
for c in recent_courses:
    print("-", c.title)