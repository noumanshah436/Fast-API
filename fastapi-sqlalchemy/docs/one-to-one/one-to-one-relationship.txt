class User(PostgresModel):
    __tablename__ = "users"

    name = Column(String)
    email = Column(String, unique=True, nullable=False)

    posts = relationship("Post", back_populates="user")
    profile = relationship("Profile", back_populates="user", uselist=False)

class Profile(PostgresModel):
    __tablename__ = "profiles"

    bio = Column(String)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, unique=True)

    user = relationship("User", back_populates="profile")


---

Read User (by ID)
from sqlalchemy import select

result = await session.execute(
    select(User).where(User.id == 1)
)
user = result.scalar_one_or_none()

print(user)

---

Create Profile (linked to User)

Option 1: via user_id

profile = Profile(
    bio="Backend Engineer",
    user_id=user.id,
)

session.add(profile)
await session.commit()
await session.refresh(profile)

---

Option 2: via relationship (recommended)

profile = Profile(
    bio="Backend Engineer",
    user=user,
)

session.add(profile)
await session.commit()
await session.refresh(profile)


---

Read Profile

result = await session.execute(
    select(Profile).where(Profile.id == 2)
)
profile = result.scalar_one_or_none()

print(profile)
print(profile.user)  # relationship works (may not work if user not in memory already)

---

Read Profile with user

result = await session.execute(
    select(Profile).options(selectinload(Profile.user)).where(Profile.id == 2)
)
profile = result.scalar_one_or_none()
print(profile)
print(profile.user)  # work fine

---

Update Profile:

profile.bio = "Senior Backend Engineer"
await session.commit()
await session.refresh(profile)

---

Delete Profile
await session.delete(profile)
await session.commit()

---

Create User + Profile together (transaction-safe)
user = User(
    name="Nouman042",
    email="nouman042@gmail.com",
)

profile = Profile(
    bio="Full Stack Developer",
    user=user,
)

session.add_all([user, profile])
await session.commit()

await session.refresh(user)
await session.refresh(profile)

---
Fetch user with profile:

from sqlalchemy.future import select
from sqlalchemy.orm import selectinload

stmt = select(User).options(selectinload(User.profile))
result = await session.execute(stmt)
user = result.scalar_one()

---

Fetch User → Profile → Back to User (another way):

user = await session.get(User, 1)
await session.refresh(user, attribute_names=["profile"])

print(user.profile.bio)
print(user.profile.user.name)  # backref